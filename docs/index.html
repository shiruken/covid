<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Confirmed COVID-19 Case Tracker</title>
    <meta name="description" content="Zoomable COVID-19 case tracker map for the United States with county-level detail.">
    <meta name="keywords" content="COVID-19, Coronavirus, SARS-CoV-2, D3, D3.js, Map, Interactive, United States, Cases, Outbreak, Pandemic">
    <meta name="author" content="Colin Sullender">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@shiruken">
    <meta name="twitter:title" content="Confirmed COVID-19 Case Tracker">
    <meta name="twitter:description" content="Zoomable COVID-19 case tracker map for the United States with county-level detail.">
    <meta name="twitter:image" content="https://covid.csullender.com/social.png">
    
    <meta property="og:title" content="Confirmed COVID-19 Case Tracker">
    <meta property="og:description" content="Zoomable COVID-19 case tracker map for the United States with county-level detail.">
    <meta property="og:image" content="https://covid.csullender.com/social.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="628">
    <meta property="og:url" content="https://covid.csullender.com/">
    <meta property="og:type" content="website">

    <style>
        body { 
            background: #333;
            font-family: Arial, Helvetica, sans-serif;
            color: #fff;
        }
        
        header {
            text-align: center;
        }

        header h1#title {
            margin-bottom: 5px;
        }

        header h2#subtitle {
            font-size: 1em;
            font-weight: normal;
            font-style: italic;
            color: #999;
        }

        div#map {
            width: 1000px;
            height: 600px;
            margin: 0 auto;
            touch-action: manipulation;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            color: #999;
        }

        path {
            stroke: #333;
            stroke-width: 1;
        }

        path:hover {
            stroke-width: 3;
        }

        div#tooltip {
            position: absolute;
            text-align: center;
            height: 90px;
            background: #ffffff;
            color: #333;
            padding: 0px 10px;
            pointer-events: none;
        }

        div#tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -10px;
            border-width: 10px;
            border-style: solid;
            border-color: #ffffff transparent transparent transparent;
        }

        h2.tooltip-title {
            font-size: 1.0em;
            margin: 10px;
        }

        h3.tooltip-subtitle {
            font-size: 0.8em;
            color: #999;
            font-weight: lighter;
            margin: 5px;
            text-transform: uppercase
        }

        div.tooltip-value {
            font-size: 1.0em;
            margin: 5px;
            font-weight: bold;
        }

        .legend text.label {
            fill: white;
        }

        a, a:visited {
            color: #999;
            text-decoration: none;
        }

        a:hover, a:active {
            border-bottom: 1px dotted #999;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="title">Confirmed COVID-19 Case Tracker</h1>
        <h2 id="subtitle"></h2>
    </header>
    <div id="map"></div>
    <footer>
        <p>
            Data from 
            <a href="https://covidtracking.com/" target="_blank">COVID Tracking Project</a>  
            and <a href="https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/" target="_blank">USAFacts</a> Â· 
            <a href="https://github.com/shiruken/covid_choropleth" target="_blank">View on GitHub</a>
        </p>
    </footer>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script>
    
    const width = 960,
        height = 600;
    var isZoomed = false;

    var projection = d3.geoAlbersUsa()
        .scale(height * 2)
        .translate([width / 2, height / 2])

    var path = d3.geoPath()
        .projection(projection)

    var svg = d3.select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)

    var tooltip = d3.select("#map")
        .append("div")
        .attr("id", "tooltip")
        .style("opacity", 0);

    var isTouch = !!('ontouchstart' in window || navigator.maxTouchPoints);
    var subtitle = d3.select('#subtitle');

    if (isTouch)
        subtitle.text('Click a state for details. Double-click to zoom.');
    else
        subtitle.text('Click a state to zoom');

    var promises = [
        d3.json("counties-10m.json"),
        d3.csv("data.csv")
    ]

    Promise.all(promises).then(function([us, data]) {

        var states = topojson.feature(us, us.objects.states).features;
        var counties = topojson.feature(us, us.objects.counties).features;

        var cases = {};
        data.forEach(function (d) {
            cases[+d.FIPS] = +d.cases;
        });

        states.forEach(function (d) {
            d.cases = cases[+d.id] || 0;
        });

        counties.forEach(function (d) {
            d.cases = cases[+d.id] || 0;
        })

        var domains = [1, 50, 100, 500, 1000, 5000, 10000];
        var color = d3.scaleThreshold()
            .domain(domains)
            .range(d3.schemeReds[8])

        var statePaths = svg.selectAll('.state')
            .data(states)
            .enter().append('path')
            .attr('class', 'state')
            .attr('d', path)
            .style('fill', function (d) { return color(d.cases); });

        if (isTouch) {
            statePaths.on('dblclick', function (d) { stateZoom(d); })
            .on("click", function(d) {
                if (!isZoomed && (d.id != tooltip.attr("data-id") || tooltip.style("opacity") == 0))
                    showTooltip(this,d);
                else
                    hideTooltip();
            });
        } else {
            statePaths.on('click', function (d) { stateZoom(d); })
            .on("mouseover", function(d) {
                if (!isZoomed)
                    showTooltip(this,d);
            })
            .on("mouseout", hideTooltip);
        }

        svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(825,390)");

        function labelGenerate(x) {
            if (x.i === 0) {
                return `None`;
            } else if (x.i === x.genLength - 1) {
                const values = x.generatedLabels[x.i].split(` ${x.labelDelimiter} `);
                return `${values[0]} or more`;
            } else {
                const values = x.generatedLabels[x.i].split(` ${x.labelDelimiter} `);
                return `${values[0]} to ${values[1] - 1}`;
            }
        }

        var legend = d3.legendColor()
            .labelFormat(d3.format("d"))
            .labels(labelGenerate)
            .scale(color)
            .shapePadding(5);

        svg.select(".legend")
            .call(legend);

        function usZoom() {
            var t = d3.transition().duration(800)

            projection.scale(height * 2).translate([width / 2, height / 2])

            statePaths.transition(t)
                .attr('d', path)
                .style('fill', function (d) { return color(d.cases); })
                .on('end', function() {
                    tooltip.style('visibility', 'visible');
                })
                .on('start', function() {
                    tooltip.style('visibility', 'hidden');
                });
                
            svg.selectAll('.county')
                .data([])
                .exit().transition(t)
                .attr('d', path)
                .style('opacity', 0)
                .remove()

            legend.scale(color);
            svg.select(".legend")
                .call(legend);

            if (isTouch)
                subtitle.text('Click a state for details. Double-click to zoom.');
            else
                subtitle.text('Click a state to zoom');

            isZoomed = false;
        }

        function stateZoom(state) {

            var stateCounties = counties.filter(function (d) {
                return d.id > state.id*1000 && d.id < state.id*1000 + 1000
            })

            var max_state = d3.max(stateCounties, function(d) { return d.cases; } );

            var index = domains.findIndex(function(x) {
                return x > max_state;
            });
            
            if (index == -1)
                index = domains.length;
            else if (index <= 1)
                index = 2;

            var color_state = d3.scaleThreshold()
                .domain(domains.slice(0, index))
                .range(d3.schemeReds[index + 1])

            var countyPaths = svg.selectAll('.county')
                .data(stateCounties, function (d) { return d.id })

            var enterCountyPaths = countyPaths.enter().append('path')
                .attr('class', 'county')
                .attr('d', path)
                .style('fill', function (d) { return color_state(d.cases); })
                .style('opacity', 0);

            if (isTouch) {
                enterCountyPaths.on('dblclick', usZoom)
                .on("click", function(d) {
                    if (d.id != tooltip.attr("data-id") || tooltip.style("opacity") == 0)
                        showTooltip(this,d);
                    else
                        hideTooltip();
                });
            } else {
                enterCountyPaths.on('click', usZoom)
                .on("mouseover", function(d) { showTooltip(this,d); })
                .on("mouseout", hideTooltip);
            }

            legend.scale(color_state);
            svg.select(".legend")
                .call(legend);

            projection.fitExtent([[80, 20], [width - 160, height - 20]], state);

            var t = d3.transition().duration(800);

            statePaths.transition(t)
                .attr('d', path)
                .style('fill', '#444');

            enterCountyPaths.transition(t)
                .attr('d', path)
                .style('opacity', 1)
                .on('end', function() {
                    tooltip.style('visibility', 'visible');
                })
                .on('start', function() {
                    tooltip.style('visibility', 'hidden');
                });

            countyPaths.exit().transition(t)
                .attr('d', path)
                .style('opacity', 0)
                .remove();

            if (isTouch)
                subtitle.text('Click a county for details. Double-click to zoom out.');
            else
                subtitle.text('Click a county to zoom out. Click another state to swap focus.');

            isZoomed = true;
        }

        function showTooltip(p,d) {

            tooltip.attr("data-id", d.id)
                .html(
                    "<h2 class='tooltip-title'>" + d.properties.name + "</h2>" +
                    "<h3 class='tooltip-subtitle'>Confirmed Cases</h3>" + 
                    "<div class='tooltip-value'>" + d.cases.toLocaleString() + "</div>"
                );

            var bounds = d3.select(p).node().getBoundingClientRect();
            var tooltip_width = tooltip.style('width').slice(0,-2);
            tooltip.style("left", (bounds['left'] + bounds['width'] / 2 - tooltip_width / 2 - 10) + "px")
                .style("top", (bounds['top'] - 100) + "px")
                .transition()
                .duration(200)
                .style("opacity", 1);
        }

        function hideTooltip() {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);	
        }
    });

    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-26412009-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-26412009-1');
    </script>

</body>
</html>