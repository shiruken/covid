<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Zoomable COVID-19 Tracker</title>
    <meta name="description" content="Zoomable COVID-19 map for the United States with county-level detail.">
    <meta name="keywords" content="COVID-19, Coronavirus, SARS-CoV-2, D3, D3.js, Map, Interactive, United States, Cases, Outbreak, Pandemic">
    <meta name="author" content="Colin Sullender">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@shiruken">
    <meta name="twitter:title" content="Zoomable COVID-19 Tracker">
    <meta name="twitter:description" content="Zoomable COVID-19 map for the United States with county-level detail.">
    <meta name="twitter:image" content="https://covid.csullender.com/social.png">
    
    <meta property="og:title" content="Zoomable COVID-19 Tracker">
    <meta property="og:description" content="Zoomable COVID-19 map for the United States with county-level detail.">
    <meta property="og:image" content="https://covid.csullender.com/social.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="628">
    <meta property="og:url" content="https://covid.csullender.com/">
    <meta property="og:type" content="website">

    <style>
        body { 
            background: #333;
            font-family: Arial, Helvetica, sans-serif;
            color: #fff;
        }
        
        header {
            text-align: center;
        }

        header h1#title {
            margin-bottom: 5px;
        }

        header h2#subtitle {
            font-size: 1em;
            font-weight: normal;
            font-style: italic;
            color: #999;
        }

        div#controls {
            text-align: center;
        }

        #controls button {
            padding: 5px;
            font-size: 1em;
        }

        button.selected {
            opacity: 0.5;
            cursor: not-allowed;
        }

        div#map {
            width: 1000px;
            height: 600px;
            margin: 0 auto;
            touch-action: manipulation;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            color: #999;
        }

        path {
            stroke: #333;
            stroke-width: 1;
        }

        path:hover {
            stroke-width: 3;
        }

        div#tooltip {
            position: absolute;
            text-align: center;
            height: 120px;
            min-width: 225px;
            background: #ffffff;
            color: #333;
            padding: 0px 10px;
            pointer-events: none;
            filter: drop-shadow(0px 10px 5px rgba(0, 0, 0, 0.5));
        }

        div#tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -10px;
            border-width: 10px;
            border-style: solid;
            border-color: #ffffff transparent transparent transparent;
        }

        div.tooltip-left, div.tooltip-center, div.tooltip-right {
            width: 33%;
        }

        div.tooltip-left {
            float: left;
        }

        div.tooltip-right {
            float: right;
        }

        div.tooltip-center {
            display: inline-block;
        }

        h2.tooltip-title {
            font-size: 1.2em;
            margin: 10px;
        }

        h3.tooltip-subtitle, h5.tooltip-desc {
            color: #666;
        }

        h3.tooltip-subtitle {
            font-size: 0.8em;
            margin: 5px 5px 0px 5px; 
            text-transform: uppercase
        }

        h5.tooltip-desc {
            margin: 0px;
            font-size: 0.7em;
        }

        div.tooltip-value {
            font-size: 1.0em;
            margin: 5px;
            font-weight: bold;
        }

        .legend text.legendTitle {
            fill: white;
            font-weight: bold;
        }

        .legend text.label {
            fill: white;
            font-size: 0.9em;
        }

        a, a:visited {
            color: #999;
            text-decoration: none;
        }

        a:hover, a:active {
            border-bottom: 1px dotted #999;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="title">Zoomable COVID-19 Tracker</h1>
        <div id="controls">
            Data to Display: 
            <button type="button" id="cases_percapita" class="selected" title="View cases per capita">Cases Per Capita</button> 
            <button type="button" id="cases" title="View total cases">Cases</button>
            <button type="button" id="deaths" title="View total deaths">Deaths</button>
        </div>
        <h2 id="subtitle"></h2>
    </header>
    <div id="map"></div>
    <footer>
        <p>
            Data from 
            <a href="https://covidtracking.com/" target="_blank">COVID Tracking Project</a>  
            and <a href="https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/" target="_blank">USAFacts</a> Â· 
            <a href="https://github.com/shiruken/covid_choropleth" target="_blank">View on GitHub</a>
        </p>
    </footer>

    <script src="https://d3js.org/d3.v5.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/topojson.v2.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" type="text/javascript"></script>
    <script type="text/javascript">
    
    const width = 960,
        height = 600;
    var isZoomed = false;
    var currentView = "cases_percapita"; // Default view

    // Define colormap thresholds for each data view
    var domains_us_cases_percapita = [100, 250, 500, 750, 1000, 1500, 2000]
        domains_state_cases_percapita = [1, 100, 250, 500, 750, 1000, 1500, 2000, 5000]
        domains_us_cases = [1000, 5000, 10000, 25000, 50000, 100000, 250000]
        domains_state_cases = [1, 100, 500, 1000, 5000, 10000, 25000, 50000]
        domains_us_deaths = [50, 100, 500, 1000, 2500, 5000, 10000]
        domains_state_deaths = [1, 10, 50, 100, 500, 1000, 2500, 5000];

    var projection = d3.geoAlbersUsa()
        .scale(height * 2)
        .translate([width / 2, height / 2])

    var path = d3.geoPath()
        .projection(projection)

    var svg = d3.select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)

    var tooltip = d3.select("#map")
        .append("div")
        .attr("id", "tooltip")
        .style("opacity", 0);

    var isTouch = !!('ontouchstart' in window || navigator.maxTouchPoints);
    var subtitle = d3.select('#subtitle');

    if (isTouch)
        subtitle.text('Click a state for details. Double-click to zoom.');
    else
        subtitle.text('Click a state to zoom');

    var promises = [
        d3.json("counties-10m.json"),
        d3.csv("data.csv")
    ]

    Promise.all(promises).then(function([us, data]) {

        var states = topojson.feature(us, us.objects.states).features;
        var counties = topojson.feature(us, us.objects.counties).features;

        var cases = {};
        var cases_percapita = {};
        var deaths = {};
        data.forEach(function (d) {
            cases[+d.FIPS] = +d.cases;
            cases_percapita[+d.FIPS] = +d.cases_percapita;
            deaths[+d.FIPS] = +d.deaths;
        });

        var totalCases = 0;
        states.forEach(function (d) {
            d.cases = cases[+d.id] || 0;
            d.cases_percapita = cases_percapita[+d.id] || 0.0;
            d.deaths = deaths[+d.id] || 0;
            totalCases += d.cases;
        });

        d3.select("#title").text(d3.select("#title").text() + " (" + totalCases.toLocaleString() + " cases)");

        counties.forEach(function (d) {
            d.cases = cases[+d.id] || 0;
            d.cases_percapita = cases_percapita[+d.id] || 0.0;
            d.deaths = deaths[+d.id] || 0;
        })

        // Calculate colormaps for all country-level views and select starting view
        var color_us_cases_percapita = d3.scaleThreshold()
            .domain(domains_us_cases_percapita)
            .range(d3.schemeReds[domains_us_cases_percapita.length + 1]);
        var color_us_cases = d3.scaleThreshold()
            .domain(domains_us_cases)
            .range(d3.schemeReds[domains_us_cases.length + 1]);
        var color_us_deaths = d3.scaleThreshold()
            .domain(domains_us_deaths)
            .range(d3.schemeReds[domains_us_deaths.length + 1]);
        var color_us = color_us_cases_percapita;

        var statePaths = svg.selectAll('.state')
            .data(states)
            .enter().append('path')
            .attr('class', 'state')
            .attr('d', path)
            .style('fill', function (d) { return color_us(d.cases_percapita); });

        var stateCounties;
        var enterCountyPaths;

        if (isTouch) {
            statePaths.on('dblclick', function (d) { stateZoom(d); })
            .on("click", function(d) {
                if (!isZoomed && (d.id != tooltip.attr("data-id") || tooltip.style("opacity") == 0))
                    showTooltip(this,d);
                else
                    hideTooltip();
            });
        } else {
            statePaths.on('click', function (d) { stateZoom(d); })
            .on("mouseover", function(d) {
                if (!isZoomed)
                    showTooltip(this,d);
            })
            .on("mouseout", hideTooltip);
        }

        svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(810,390)");

        function labelGenerate(x) {
            if (x.i === 0) {
                if (x.domain[0] === 1)
                    return 'None'; 
                else
                    return `Less than ${x.domain[0].toLocaleString()}`;
            } else if (x.i === x.genLength - 1) {
                const values = x.generatedLabels[x.i].split(` ${x.labelDelimiter} `);
                return `More than ${parseInt(values[0]).toLocaleString()}`;
            } else {
                const values = x.generatedLabels[x.i].split(` ${x.labelDelimiter} `);
                return `${x.domain[(x.i - 1)].toLocaleString()} to ${(x.domain[x.i] - 1).toLocaleString()}`;
            }
        }

        var legend = d3.legendColor()
            .labelFormat(d3.format("d"))
            .labels(labelGenerate)
            .scale(color_us)
            .shapePadding(5)
            .title("Cases Per 100,000");

        svg.select(".legend")
            .call(legend);

        function usZoom() {

            isZoomed = false;

            var t = d3.transition().duration(800)

            projection.scale(height * 2).translate([width / 2, height / 2])

            statePaths.transition(t)
                .attr('d', path)
                .style('fill', function (d) {
                    if (currentView == "cases_percapita")
                        return color_us(d.cases_percapita);
                    else if (currentView == "cases")
                        return color_us(d.cases);
                    else if (currentView == "deaths")
                        return color_us(d.deaths);
                })
                .on('end', function() {
                    tooltip.style('visibility', 'visible');
                })
                .on('start', function() {
                    tooltip.style('visibility', 'hidden');
                });
                
            svg.selectAll('.county')
                .data([])
                .exit().transition(t)
                .attr('d', path)
                .style('opacity', 0)
                .remove()

            legend.scale(color_us);
            svg.select(".legend")
                .call(legend);

            if (isTouch)
                subtitle.text('Click a state for details. Double-click to zoom.');
            else
                subtitle.text('Click a state to zoom');
        }

        function stateZoom(state) {

            isZoomed = true;

            stateCounties = counties.filter(function (d) {
                return d.id > state.id*1000 && d.id < state.id*1000 + 1000
            });

            // Get state-level domains and extract minimum and maximum values from county-level data
            var stateDomains = [];
            var minStateCases = [];
            var maxStateCases = [];
            if (currentView == "cases_percapita") {
                stateDomains = domains_state_cases_percapita;
                minStateCases = d3.min(stateCounties, function(d) { return d.cases_percapita; } );
                maxStateCases = d3.max(stateCounties, function(d) { return d.cases_percapita; } );
            } else if (currentView == "cases") {
                stateDomains = domains_state_cases;
                minStateCases = d3.min(stateCounties, function(d) { return d.cases; } );
                maxStateCases = d3.max(stateCounties, function(d) { return d.cases; } );
            } else if (currentView == "deaths") {
                stateDomains = domains_state_deaths;
                minStateCases = d3.min(stateCounties, function(d) { return d.deaths; } );
                maxStateCases = d3.max(stateCounties, function(d) { return d.deaths; } );
            }

            // Use the "Less than X" nomenclature when there are only nonzero counts in state view
            if (minStateCases === 0)
                idx_start = 0;
            else
                idx_start = 1;

            // Truncate colormap at index above maximum value in county-level data
            var idx_stop = stateDomains.findIndex(function(x) {
                return x > maxStateCases;
            });
            
            // Handle edge cases in determining domain range
            if (idx_stop == -1) {
                idx_stop = stateDomains.length;
                idx_start = 1;
            } else if (idx_stop <= 1)
                idx_stop = 2;

            // Define the county-level colormap
            var color_state = d3.scaleThreshold()
                .domain(stateDomains.slice(idx_start, idx_stop))
                .range(d3.schemeReds[idx_stop + 1 - idx_start]);

            var countyPaths = svg.selectAll('.county')
                .data(stateCounties, function (d) { return d.id });

            enterCountyPaths = countyPaths.enter().append('path')
                .attr('class', 'county')
                .attr('d', path)
                .style('fill', function (d) { 
                    if (currentView == "cases_percapita")
                        return color_state(d.cases_percapita);
                    else if (currentView == "cases")
                        return color_state(d.cases);
                    else if (currentView == "deaths")
                        return color_state(d.deaths);
                })
                .style('opacity', 0);

            if (isTouch) {
                enterCountyPaths.on('dblclick', usZoom)
                .on("click", function(d) {
                    if (d.id != tooltip.attr("data-id") || tooltip.style("opacity") == 0)
                        showTooltip(this,d);
                    else
                        hideTooltip();
                });
            } else {
                enterCountyPaths.on('click', usZoom)
                .on("mouseover", function(d) { showTooltip(this,d); })
                .on("mouseout", hideTooltip);
            }

            legend.scale(color_state);
            svg.select(".legend")
                .call(legend);

            projection.fitExtent([[80, 20], [width - 160, height - 20]], state);

            var t = d3.transition().duration(800);

            statePaths.transition(t)
                .attr('d', path)
                .style('fill', '#444');

            enterCountyPaths.transition(t)
                .attr('d', path)
                .style('opacity', 1)
                .on('end', function() {
                    tooltip.style('visibility', 'visible');
                })
                .on('start', function() {
                    tooltip.style('visibility', 'hidden');
                });

            countyPaths.exit().transition(t)
                .attr('d', path)
                .style('opacity', 0)
                .remove();

            if (isTouch)
                subtitle.text('Click a county for details. Double-click to zoom out.');
            else
                subtitle.text('Click a county to zoom out. Click another state to swap focus.');
        }

        // Listen for button press to change displayed data
        d3.selectAll("div#controls button").on("click", function() {

            currentView = this.id;

            // Update selected control button
            d3.selectAll('div#controls button').classed("selected", false);
            d3.select(this).classed("selected", true);

            // Update data shown on map
            if (isZoomed) {
                var stateDomains = [];
                var minStateCases = [];
                var maxStateCases = [];
                if (this.id === "cases_percapita") {
                    stateDomains = domains_state_cases_percapita;
                    minStateCases = d3.min(stateCounties, function(d) { return d.cases_percapita; } );
                    maxStateCases = d3.max(stateCounties, function(d) { return d.cases_percapita; } );
                } else if (this.id === "cases") {
                    stateDomains = domains_state_cases;
                    minStateCases = d3.min(stateCounties, function(d) { return d.cases; } );
                    maxStateCases = d3.max(stateCounties, function(d) { return d.cases; } );
                } else if (this.id === "deaths") {
                    stateDomains = domains_state_deaths;
                    minStateCases = d3.min(stateCounties, function(d) { return d.deaths; } );
                    maxStateCases = d3.max(stateCounties, function(d) { return d.deaths; } );
                }

                // Use the "Less than X" nomenclature when there are only nonzero counts in state view
                if (minStateCases === 0)
                    idx_start = 0;
                else
                    idx_start = 1;

                // Truncate colormap at index above maximum value in county-level data
                var idx_stop = stateDomains.findIndex(function(x) {
                    return x > maxStateCases;
                });
                
                // Handle edge cases in determining domain range
                if (idx_stop == -1) {
                    idx_stop = stateDomains.length;
                    idx_start = 1;
                } else if (idx_stop <= 1)
                    idx_stop = 2;

                // Define the county-level colormap
                var color_state = d3.scaleThreshold()
                    .domain(stateDomains.slice(idx_start, idx_stop))
                    .range(d3.schemeReds[idx_stop + 1 - idx_start]);    

                if (this.id === "cases_percapita") {
                    enterCountyPaths.style('fill', function (d) { return color_state(d.cases_percapita); });
                } else if (this.id === "cases") {
                    enterCountyPaths.style('fill', function (d) { return color_state(d.cases); });
                } else if (this.id === "deaths") {
                    enterCountyPaths.style('fill', function (d) { return color_state(d.deaths); });
                }

                legend.scale(color_state);

            } else {
                if (this.id === "cases_percapita") {
                    statePaths.style('fill', function (d) { return color_us_cases_percapita(d.cases_percapita); });
                    legend.scale(color_us_cases_percapita);
                } else if (this.id === "cases") {
                    statePaths.style('fill', function (d) { return color_us_cases(d.cases); });
                    legend.scale(color_us_cases);
                } else if (this.id === "deaths") {
                    statePaths.style('fill', function (d) { return color_us_deaths(d.deaths); });
                    legend.scale(color_us_deaths);
                }
            }

            if (this.id === "cases_percapita") {
                color_us = color_us_cases_percapita;
                legend.title('Cases Per 100,000');
            } else if (this.id === "cases") {
                color_us = color_us_cases;
                legend.title('Cases');
            } else if (this.id === "deaths") {
                color_us = color_us_deaths;
                legend.title('Deaths');
            }

            // Draw updated legend
            svg.select(".legend").call(legend);
        });

        function showTooltip(p,d) {

            tooltip.attr("data-id", d.id)
                .html(
                    "<h2 class='tooltip-title'>" + d.properties.name + "</h2>" +
                    "<div class='tooltip-center'>" +
                        "<h3 class='tooltip-subtitle'>Cases</h3>" + 
                        "<h5 class='tooltip-desc'>Total</h5>" +
                        "<div class='tooltip-value'>" + d.cases.toLocaleString() + "</div>" + 
                    "</div>" + 
                    "<div class='tooltip-left'>" +
                        "<h3 class='tooltip-subtitle'>Cases</h3>" + 
                        "<h5 class='tooltip-desc'>Per 100k</h5>" +
                        "<div class='tooltip-value'>" + d.cases_percapita.toLocaleString() + "</div>" + 
                    "</div>" + 
                    "<div class='tooltip-right'>" +
                        "<h3 class='tooltip-subtitle'>Deaths</h3>" + 
                        "<h5 class='tooltip-desc'>Total</h5>" +
                        "<div class='tooltip-value'>" + d.deaths.toLocaleString() + "</div>" +
                    "</div>"
                );

            var bounds = d3.select(p).node().getBoundingClientRect();
            var tooltip_width = tooltip.style('width').slice(0,-2);
            tooltip.style("left", (bounds['left'] + bounds['width'] / 2 - tooltip_width / 2 - 10) + "px")
                .style("top", (bounds['top'] - 130) + "px")
                .transition()
                .duration(200)
                .style("opacity", 1);
        }

        function hideTooltip() {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);	
        }
    });

    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-26412009-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-26412009-1');
    </script>

</body>
</html>