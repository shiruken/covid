<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body { background: #333; font-family: Arial, Helvetica, sans-serif; color: #fff; }
    h1 { text-align: center; }
    div#content, div#footer { width: 1000px; margin: auto; }
    div#footer { text-align: center; position: fixed; left: 0px; bottom: 0px; width: 100%; margin-bottom: 10px; }
    path { stroke: #333; stroke-width: 1; }
    path:hover { stroke-width: 3; }
    .legend text.label { fill: white; }
    a, a:visited { color: #ffffff; text-decoration: none; }
    a:hover, a:active { border-bottom: 1px dotted #ffffff; }
</style>
<body>

<h1>Confirmed COVID-19 Case Tracker</h1>
<div id="content"></div>
<div id="footer">Data by <a href="https://usafacts.org/" target="_blank">USAFacts</a> | <a href="https://github.com/shiruken/covid_choropleth" target="_blank">View on GitHub</a></div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
<script>

const width = 960,
    height = 600,
    padding = 20

var projection = d3.geoAlbersUsa()
    .precision(0)
    .scale(height * 2).translate([width / 2, height / 2])

var path = d3.geoPath().projection(projection)

var svg = d3.select('#content')
    .append('svg')
    .attr('width', width)
    .attr('height', height)

d3.queue()
    .defer(d3.csv, 'data.csv', function (d) {
        return {
            id: +d.id,
            name: d.name,
            cases: +d.cases
        }
    })
    .defer(d3.json, 'us-states.json')
    .defer(d3.json, 'us-counties.json')
    .awaitAll(initialize)

function initialize(error, results) {
    if (error) { throw error }

    var data = results[0]
    var states = topojson.feature(results[1], results[1].objects.states).features
    var counties = topojson.feature(results[2], results[2].objects.counties).features

    states.forEach(function (f) {
        f.properties = data.find(function (d) { return d.id === f.id })
    })

    counties.forEach(function (f) {
        f.properties = data.find(function (d) { return d.id === f.id }) || {}
    })

    var domains = [1, 10, 50, 100, 500, 1000, 2000];
    var color = d3.scaleThreshold()
        .domain(domains)
        .range(d3.schemeReds[8])

    var statePaths = svg.selectAll('.state')
        .data(states)
        .enter().append('path')
        .attr('class', 'state')
        .attr('d', path)
        .style('fill', function (d) { return color(d.properties.cases); })
        .on('click', function (d) { stateZoom(d.id) })

    statePaths.append('svg:title')
        .text(function (d) { return d.properties.name + ": " + d.properties.cases });

    svg.append("g")
        .attr("class", "legend")
        .attr("transform", "translate(825,390)");

    function labelGenerate(x) {
        if (x.i === 0) {
            return `None`;
        } else if (x.i === x.genLength - 1) {
            const values = x.generatedLabels[x.i].split(` ${x.labelDelimiter} `);
            return `${values[0]} or more`;
        } else {
            const values = x.generatedLabels[x.i].split(` ${x.labelDelimiter} `);
            return `${values[0]} to ${values[1] - 1}`;
        }
    }

    var legend = d3.legendColor()
        .labelFormat(d3.format("d"))
        .labels(labelGenerate)
        .scale(color)
        .shapePadding(5);

    svg.select(".legend")
        .call(legend);

    function usZoom() {
        var t = d3.transition().duration(800)

        projection.scale(height * 2).translate([width / 2, height / 2])

        statePaths.transition(t)
            .attr('d', path)
            .style('fill', function (d) { return color(d.properties.cases); })

        svg.selectAll('.county')
            .data([])
            .exit().transition(t)
            .attr('d', path)
            .style('opacity', 0)
            .remove()

        legend.scale(color);
        svg.select(".legend")
            .call(legend);
    }

    function stateZoom(id) {
        var state = states.find(function (d) { return d.id === id })
        var stateCounties = counties.filter(function (d) {
            return d.id > id && d.id < id + 1000
        })

        var max_state = d3.max(stateCounties, function(d) { return d.properties.cases; } );

        var index = domains.findIndex(function(x) {
            return x > max_state;
        });

        if (index <= 1)
            index = 2;

        var color_state = d3.scaleThreshold()
            .domain(domains.slice(0, index))
            .range(d3.schemeReds[index + 1])

        var t = d3.transition().duration(800)

        var countyPaths = svg.selectAll('.county')
            .data(stateCounties, function (d) { return d.id })

        var enterCountyPaths = countyPaths.enter().append('path')
            .attr('class', 'county')
            .attr('d', path)
            .style('fill', function (d) { return color_state(d.properties.cases); })
            .style('opacity', 0)
            .on('click', function () { usZoom() })

        enterCountyPaths.append('svg:title')
            .text(function (d) { return d.properties.name + ": " + d.properties.cases });

        legend.scale(color_state);
        svg.select(".legend")
            .call(legend);

        projection.fitExtent(
            [[padding*4, padding], [width - padding*8, height - padding]],
            state
        )

        statePaths.transition(t)
            .attr('d', path)
            .style('fill', '#444')

        enterCountyPaths.transition(t)
            .attr('d', path)
            .style('opacity', 1)

        countyPaths.exit().transition(t)
            .attr('d', path)
            .style('opacity', 0)
            .remove()
    }
}

</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160907292-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-160907292-1');
</script>

</body>